<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IPFS Reverse Proxy - Manual Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
      border-bottom: 3px solid #007acc;
      padding-bottom: 10px;
    }

    .config-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 4px solid #007acc;
    }

    .test-section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    .test-section h3 {
      margin-top: 0;
      color: #555;
    }

    input,
    button,
    select {
      padding: 10px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    input[type="text"] {
      width: 300px;
    }

    button {
      background: #007acc;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
    }

    button:hover {
      background: #005a9e;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .result {
      margin: 15px 0;
      padding: 15px;
      border-radius: 6px;
      font-family: monospace;
      white-space: pre-wrap;
    }

    .success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }

    .loading {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }

    img {
      max-width: 100%;
      height: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-healthy {
      background: #28a745;
    }

    .status-unhealthy {
      background: #dc3545;
    }

    .status-unknown {
      background: #6c757d;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üöÄ IPFS Reverse Proxy - Manual Test</h1>

    <div class="config-section">
      <h3>‚öôÔ∏è Configuration</h3>
      <div>
        <label>Proxy URL:</label><br>
        <input type="text" id="proxyUrl" value="https://ipfs.wallacemuseum.com"
          placeholder="https://ipfs.wallacemuseum.com">
        <small>Use http://localhost:3000 for local testing</small>
      </div>
      <div>
        <label>API Key:</label><br>
        <input type="text" id="apiKey" placeholder="your_api_key_here">
        <small>Your secure API key</small>
      </div>
      <button onclick="saveConfig()">üíæ Save Config</button>
    </div>

    <div class="grid">
      <div class="test-section">
        <h3>üè• Health Check</h3>
        <button onclick="testHealth()">Check Health</button>
        <div id="healthResult"></div>
      </div>

      <div class="test-section">
        <h3>üîê Authentication Test</h3>
        <button onclick="testAuth()">Test Auth</button>
        <div id="authResult"></div>
      </div>
    </div>

    <div class="test-section">
      <h3>üìÑ Text Content Test</h3>
      <input type="text" id="textHash" value="QmT78zSuBmuS4z925WZfrqQ1qHaJ56DQaTfyMUF7F8ff5o" placeholder="IPFS hash">
      <button onclick="testTextContent()">Load Text</button>
      <div id="textResult"></div>
    </div>

    <div class="test-section">
      <h3>üñºÔ∏è Image Content Test</h3>
      <input type="text" id="imageHash" value="QmYwAPJzv5CZsnA625s3Xf2nemtYgPpHdWEz79ojWnPbdG" placeholder="IPFS hash">
      <button onclick="testImageContent()">Load Image</button>
      <div id="imageResult"></div>
    </div>

    <div class="test-section">
      <h3>üîó URL Rewrite Test</h3>
      <input type="text" id="rewriteHash" value="QmT78zSuBmuS4z925WZfrqQ1qHaJ56DQaTfyMUF7F8ff5o"
        placeholder="IPFS hash">
      <select id="rewriteType">
        <option value="ipfs">/ipfs/ path</option>
        <option value="gateway">/gateway/ path</option>
        <option value="api">/api/proxy path</option>
      </select>
      <button onclick="testUrlRewrite()">Test Rewrite</button>
      <div id="rewriteResult"></div>
    </div>

    <div class="test-section">
      <h3>üéØ Custom Hash Test</h3>
      <input type="text" id="customHash" placeholder="Enter your own IPFS hash">
      <select id="contentType">
        <option value="auto">Auto-detect</option>
        <option value="text">Text</option>
        <option value="image">Image</option>
        <option value="json">JSON</option>
      </select>
      <button onclick="testCustomHash()">Test Custom Hash</button>
      <div id="customResult"></div>
    </div>
  </div>

  <script>
    // Configuration management
    function saveConfig() {
      const proxyUrl = document.getElementById('proxyUrl').value;
      const apiKey = document.getElementById('apiKey').value;

      localStorage.setItem('proxyUrl', proxyUrl);
      localStorage.setItem('apiKey', apiKey);

      showResult('configResult', 'Configuration saved!', 'success');
    }

    function loadConfig() {
      const proxyUrl = localStorage.getItem('proxyUrl');
      const apiKey = localStorage.getItem('apiKey');

      if (proxyUrl) document.getElementById('proxyUrl').value = proxyUrl;
      if (apiKey) document.getElementById('apiKey').value = apiKey;
    }

    function getConfig() {
      return {
        proxyUrl: document.getElementById('proxyUrl').value.replace(/\/$/, ''),
        apiKey: document.getElementById('apiKey').value
      };
    }

    // Utility functions
    function showResult(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="result ${type}">${message}</div>`;
    }

    function showLoading(elementId, message = 'Loading...') {
      showResult(elementId, message, 'loading');
    }

    async function makeRequest(url, options = {}) {
      const config = getConfig();

      if (!config.apiKey) {
        throw new Error('Please set your API key first');
      }

      const response = await fetch(url, {
        headers: {
          'X-API-Key': config.apiKey,
          ...options.headers
        },
        ...options
      });

      return response;
    }

    // Test functions
    async function testHealth() {
      const config = getConfig();
      showLoading('healthResult');

      try {
        const response = await fetch(`${config.proxyUrl}/api/health`);
        const health = await response.json();

        const statusClass = health.status === 'healthy' ? 'status-healthy' : 'status-unhealthy';
        const result = `
<span class="status-indicator ${statusClass}"></span><strong>Status:</strong> ${health.status}
<strong>Service:</strong> ${health.service} v${health.version}
<strong>Timestamp:</strong> ${health.timestamp}
<strong>Environment:</strong>
  - API Key: ${health.environment.hasApiKey ? '‚úÖ' : '‚ùå'}
  - Pinata JWT: ${health.environment.hasPinataJwt ? '‚úÖ' : '‚ùå'}
  - Allowed Origins: ${health.environment.allowedOrigins}
  - Dedicated Gateway: ${health.environment.hasDedicatedGateway ? '‚úÖ' : '‚ùå'}`;

        showResult('healthResult', result, health.status === 'healthy' ? 'success' : 'error');
      } catch (error) {
        showResult('healthResult', `Health check failed: ${error.message}`, 'error');
      }
    }

    async function testAuth() {
      const config = getConfig();
      showLoading('authResult');

      try {
        // Test without API key (should fail)
        const response = await fetch(`${config.proxyUrl}/api/proxy?hash=QmT78zSuBmuS4z925WZfrqQ1qHaJ56DQaTfyMUF7F8ff5o`);

        if (response.status === 401) {
          showResult('authResult', '‚úÖ Authentication working correctly - request rejected without API key', 'success');
        } else {
          showResult('authResult', `‚ùå Authentication not working - got status ${response.status} instead of 401`, 'error');
        }
      } catch (error) {
        showResult('authResult', `Authentication test failed: ${error.message}`, 'error');
      }
    }

    async function testTextContent() {
      const config = getConfig();
      const hash = document.getElementById('textHash').value;
      showLoading('textResult');

      try {
        const response = await makeRequest(`${config.proxyUrl}/api/proxy?hash=${hash}`);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const text = await response.text();
        const contentType = response.headers.get('content-type');

        const result = `
<strong>Status:</strong> ${response.status} ${response.statusText}
<strong>Content-Type:</strong> ${contentType}
<strong>Content-Length:</strong> ${response.headers.get('content-length') || 'unknown'}
<strong>Content Preview:</strong>
${text.substring(0, 500)}${text.length > 500 ? '...' : ''}`;

        showResult('textResult', result, 'success');
      } catch (error) {
        showResult('textResult', `Text content test failed: ${error.message}`, 'error');
      }
    }

    async function testImageContent() {
      const config = getConfig();
      const hash = document.getElementById('imageHash').value;
      showLoading('imageResult');

      try {
        const response = await makeRequest(`${config.proxyUrl}/api/proxy?hash=${hash}`);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const blob = await response.blob();
        const contentType = response.headers.get('content-type');
        const objectUrl = URL.createObjectURL(blob);

        const result = `
<strong>Status:</strong> ${response.status} ${response.statusText}
<strong>Content-Type:</strong> ${contentType}
<strong>Content-Length:</strong> ${blob.size} bytes
<strong>Cache-Control:</strong> ${response.headers.get('cache-control') || 'none'}

<img src="${objectUrl}" alt="IPFS Image" onload="URL.revokeObjectURL(this.src)">`;

        showResult('imageResult', result, 'success');
      } catch (error) {
        showResult('imageResult', `Image content test failed: ${error.message}`, 'error');
      }
    }

    async function testUrlRewrite() {
      const config = getConfig();
      const hash = document.getElementById('rewriteHash').value;
      const type = document.getElementById('rewriteType').value;
      showLoading('rewriteResult');

      let url;
      switch (type) {
        case 'ipfs':
          url = `${config.proxyUrl}/ipfs/${hash}`;
          break;
        case 'gateway':
          url = `${config.proxyUrl}/gateway/${hash}`;
          break;
        case 'api':
          url = `${config.proxyUrl}/api/proxy?hash=${hash}`;
          break;
      }

      try {
        const response = await makeRequest(url);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const text = await response.text();

        const result = `
<strong>URL:</strong> ${url}
<strong>Status:</strong> ${response.status} ${response.statusText}
<strong>Content-Type:</strong> ${response.headers.get('content-type')}
<strong>Rewrite working:</strong> ‚úÖ

<strong>Content Preview:</strong>
${text.substring(0, 200)}...`;

        showResult('rewriteResult', result, 'success');
      } catch (error) {
        showResult('rewriteResult', `URL rewrite test failed: ${error.message}`, 'error');
      }
    }

    async function testCustomHash() {
      const config = getConfig();
      const hash = document.getElementById('customHash').value;
      const contentType = document.getElementById('contentType').value;

      if (!hash) {
        showResult('customResult', 'Please enter an IPFS hash', 'error');
        return;
      }

      showLoading('customResult');

      try {
        const response = await makeRequest(`${config.proxyUrl}/api/proxy?hash=${hash}`);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const responseContentType = response.headers.get('content-type');
        let result = `
<strong>Status:</strong> ${response.status} ${response.statusText}
<strong>Content-Type:</strong> ${responseContentType}
<strong>Content-Length:</strong> ${response.headers.get('content-length') || 'unknown'}

`;

        if (contentType === 'image' || (contentType === 'auto' && responseContentType?.startsWith('image/'))) {
          const blob = await response.blob();
          const objectUrl = URL.createObjectURL(blob);
          result += `<img src="${objectUrl}" alt="IPFS Content" onload="URL.revokeObjectURL(this.src)">`;
        } else {
          const text = await response.text();
          result += `<strong>Content:</strong>\n${text.substring(0, 1000)}${text.length > 1000 ? '...' : ''}`;
        }

        showResult('customResult', result, 'success');
      } catch (error) {
        showResult('customResult', `Custom hash test failed: ${error.message}`, 'error');
      }
    }

    // Load configuration on page load
    window.onload = function () {
      loadConfig();
    };
  </script>
</body>

</html>